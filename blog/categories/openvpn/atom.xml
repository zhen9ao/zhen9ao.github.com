<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[Category: OpenVPN | Jack's Blog]]></title>
  <link href="http://zhen9ao.github.io/blog/categories/openvpn/atom.xml" rel="self"/>
  <link href="http://zhen9ao.github.io/"/>
  <updated>2013-08-08T14:52:30+08:00</updated>
  <id>http://zhen9ao.github.io/</id>
  <author>
    <name><![CDATA[zhen9ao]]></name>
    <email><![CDATA[zhen9ao@gmail.com]]></email>
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[OpenWrt的DNS配置]]></title>
    <link href="http://zhen9ao.github.io/blog/2012/12/06/openwrtde-dnspei-zhi/"/>
    <updated>2012-12-06T21:30:00+08:00</updated>
    <id>http://zhen9ao.github.io/blog/2012/12/06/openwrtde-dnspei-zhi</id>
    <content type="html"><![CDATA[<p>本文主要研究一下OpenWrt中的DNS配置的相关内容，介绍以下内容：</p>

<ol>
<li>dnsmasq的更多配置，给域名设置独立的DNS server。</li>
<li>用pdnsd配置一个更安全、快速的DNS server。</li>
</ol>


<h2>dnsmasq</h2>

<p>国外域名用Google DNS进行解析还好说，国内的域名如果用Google DNS进行解析，可能会出现返回的服务器IP不是离你最近的情况，导致服务器响应没那么快，比较常见的是Youku等视频网站。所以针对这种情况，针对国内的域名，配置国内的DNS服务。</p>

<!--more-->


<p>需要进行配置的文件就是<code>/etc/dnsmasq.conf</code>，可以把所有的域名配置都写到这个文件里，也可以像我一样新建一个配置文件夹如<code>/home/vpn/dnsmasq.d</code>，在这个文件夹中放入<code>china.conf</code>文件。而在<code>/etc/dnsmasq.conf</code>中添加如下配置：</p>

<pre><code>config-dir=/home/vpn/dnsmasq.d
</code></pre>

<p>具体的<code>china.conf</code>中的DNS server配置如下：</p>

<p>{% gist 4224532 china.conf %}</p>

<p>这样重启dnsmasq，国内的一些域名就会使用所配置的DNS Server了。</p>

<h2>pdnsd</h2>

<p>最近DNS污染严重，在使用<code>dnsmasq</code>的时候发现经常出现查询结果被污染的情况，而且返回的DNS解析结果缓存TTL时间相当长，虽然<code>dnsmasq</code>可以用TCP连接Google DNS，但是由于不能修改默认的缓存TTL时间，一般的TTL时间是20几秒，也就是说20几秒过后，要是再对刚才的域名进行请求，还要重新向Google DNS发起查询请求，这一方面会导致网络延迟加大，另一方面频繁请求，DNS cache被污染的几率就加大。</p>

<p><code>pdnsd</code>可以实现设置TTL的目的，也可以设置向DNS Server的请求为TCP连接，比较安全。</p>

<p>在OpenWrt中，要先安装</p>

<pre><code>opkg install pdnsd
</code></pre>

<p>是时候禁用dnsmasq的服务了，不过不能stop，因为dnsmasq还作为wifi的DHCP server来用，所以只能禁用DNS Server的功能，保留DHCP server。在<code>/etc/config/dhcp</code>中的<code>config dnsmasq</code>中添加如下配置：</p>

<pre><code>option port '0'
</code></pre>

<p>重启<code>dnsmasq</code>服务，这样就禁用了DNS Server的功能。</p>

<p>然后配置<code>pdnsd</code>，配置文件是<code>/etc/pdnsd.conf</code>，主要修改其中的<code>global</code>和<code>server</code>配置项，修改后如下(下面给出的是要修改的部分)：</p>

<pre><code>global {
    server_ip=any;
    query_method=tcp_only;
    min_ttl=1d;
}

server {
    ip=8.8.8.8,8.8.4.4;
    uptest=ping;
}
</code></pre>

<p>这样，就可以设置pdnsd开机启动了：</p>

<pre><code>/etc/init.d/pdnsd enable
/etc/init.d/pdnsd start
</code></pre>

<p>为了加速苹果服务器的下载，可以为苹果服务器专门设置一个DNS server</p>

<pre><code>exclude=appldlnld.apple.com,
            supportdownload.apple.com,
            swcdn.apple.com;
</code></pre>

<p>添加这样几个例外，然后新建一个<code>server</code>代码块就行了。</p>

<p>PS: 本文主要参考了：<a href="http://bullshitlie.blogspot.jp/2012/03/pdnsd-google-dns-dns.html">用PDNSD + Google DNS 获得高速正确的dns解析</a></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[在TP-Link上安装OpenWrt并配置OpenVPN]]></title>
    <link href="http://zhen9ao.github.io/blog/2012/04/10/how-to-config-openwrt-with-openvpn-on-tp-link-wr703n/"/>
    <updated>2012-04-10T10:18:00+08:00</updated>
    <id>http://zhen9ao.github.io/blog/2012/04/10/how-to-config-openwrt-with-openvpn-on-tp-link-wr703n</id>
    <content type="html"><![CDATA[<h2>路由器的选择</h2>

<p>要安装OpenWrt，首先要选择一款适合的路由器。可以在OpenWrt的官网中查看支持的<a href="http://wiki.openwrt.org/toh/start">设备列表</a>，从中选择可以使用的设备。最好选择带USB口的设备（这样可以接U盘，把需要的软件装到U盘中，比如OpenVPN和Python等组件），一般带USB口的设备都是3G路由器或比较高端的路由器，从节约成本的角度考虑，最好是选择3G路由器，高端路由器当然更好，有更强大的CPU。</p>

<p>我选择了<a href="http://www.tp-link.cn/pages/product-detail.asp?d=225">TP-Link wr703n</a>，这款路由器小巧，方便携带，但功能不弱。</p>

<h2>准备工作</h2>

<p>这里主要考虑的是wr703n只做爬墙使用，不做PPPoE拨号，所以需要准备的东西如下：</p>

<ol>
<li>网线</li>
<li>U盘（或TF卡+读卡器等）</li>
</ol>


<!--more-->


<h2>刷入固件</h2>

<ul>
<li>下载对应的ROM文件，wr703n的文件在<a href="http://downloads.openwrt.org/attitude_adjustment/12.09-rc1/ar71xx/generic/">这里</a>，这是rc1的代码库。</li>
<li>ROM分两种，分别以factory和sysupgrade固件，以factory结束的用来从官方固件刷OpenWrt，以sysupgrade结束的固件是用来更新已有的OpenWrt。所以，新买的路由器应该选择对应的factory固件。</li>
</ul>


<h3>从官方固件升级</h3>

<p>从官方固件升级比较简单，登入TP-Link的Web管理界面，在<code>软件升级</code>中选择本地的<code>openwrt-ar71xx-generic-tl-wr703n-v1-squashfs-factory.bin</code>文件，就可以刷入OpenWrt了。</p>

<h3>从OpenWrt升级</h3>

<p>从已刷过的固件升级稍微麻烦一些，步骤主要可以参考OpenWrt的<a href="http://wiki.openwrt.org/toh/tp-link/tl-wr703n">官方文档</a>，大致如下：</p>

<ol>
<li>将固件<code>openwrt-ar71xx-generic-tl-wr703n-v1-squashfs-sysupgrade.bin</code>上传到OpenWrt的<code>/tmp</code>目录中</li>
<li>登入OpenWrt管理界面，执行下面的命令

<blockquote><p>mtd write openwrt-ar71xx-generic-tl-wr703n-v1-squashfs-sysupgrade.bin firmware</p></blockquote></li>
<li>等待命令行返回后，重启路由器就完成了刷新。</li>
</ol>


<h2>网络配置</h2>

<p>默认情况下，刚刷入的OpenWrt是没有开启wifi的，所以只能由网线连结到路由器，刚刷入的路由器是没有配置root密码的，也没开启ssh，只能用telnet登陆路由器</p>

<blockquote><p>telnet 192.168.1.1</p></blockquote>

<p>不需要输入密码即可登陆，如需要配置ssh，只需要修改root密码，ssh启用后，telnet将自动失效</p>

<blockquote><p>passwd root</p></blockquote>

<p>OpenWrt需要配置的文件主要有以下几个：</p>

<ul>
<li><code>/etc/config/network</code>  配置网络</li>
<li><code>/etc/config/wireless</code>  配置无线属性</li>
<li><code>/etc/config/dhcp</code>  配置dhcp等信息</li>
<li><code>/etc/config/fstab</code>  配置USB设备自动挂载</li>
<li><code>/etc/config/firewall</code> 配置防火墙设置</li>
</ul>


<h3><code>/etc/config/network</code></h3>

<p>配置如下</p>

<pre><code>config interface 'loopback'
    option ifname 'lo'
    option proto 'static'
    option ipaddr '127.0.0.1'
    option netmask '255.0.0.0'

config interface 'wifi'
    option proto 'static'
    option ipaddr '192.168.2.1'
    option netmask '255.255.255.0'

config interface 'wan'
    option proto 'dhcp'
    option ifname 'eth0'
</code></pre>

<p>这个配置中<code>wan</code>即为与上级路由器屋里相连的网卡接口，动态分配IP地址；<code>lan</code>即为无线wifi，IP地址段设置为192.168.2.0/24。</p>

<h3><code>/etc/config/wireless</code></h3>

<pre><code>config wifi-device  radio0
    option type     mac80211
    option channel  11
    option macaddr  14:e6:e4:e7:dc:00
    option hwmode   11ng
    option htmode   HT20
    list ht_capab   SHORT-GI-20
    list ht_capab   SHORT-GI-40
    list ht_capab   RX-STBC1
    list ht_capab   DSSS_CCK-40
    # REMOVE THIS LINE TO ENABLE WIFI:
    #option disabled 1

config wifi-iface
    option device   radio0
    option network  wifi
    option mode     ap
    option ssid     yourssid
    option encryption psk2
    option key yourpassword
</code></pre>

<p>按配置文件中的提示，将<code>option disabled 1</code>注释掉即可启动wifi。将<code>yourssid</code>和<code>yourpassword</code>替换为需要设置的ssid和wifi密码，这个密码有最少8个字符长度要求。</p>

<h3><code>/etc/config/dhcp</code></h3>

<p>这个文件改动很少，可以配置dnsmasq的<code>resolvfile</code>，即DNS。可以新建一个文件<code>/etc/resolv-gpd.conf</code>，其中的内容如下(这里用的是成都电信的dns，选择自己地区的dns作为备用dns，这样访问国内网络速度要快些)</p>

<pre><code>nameserver 8.8.8.8
nameserver 8.8.4.4
nameserver 199.91.73.222
</code></pre>

<p>然后将<code>/etc/config/dhcp</code>中的<code>option resolvfile</code>选项修改为<code>/etc/resolv-gpd.conf</code>，并且配置<code>wan</code>口的dhcp，我的配置如下：</p>

<pre><code>config dnsmasq
    option domainneeded '1'
    option boguspriv '1'
    option localise_queries '1'
    option rebind_protection '1'
    option rebind_localhost '1'
    option local '/lan/'
    option domain 'lan'
    option expandhosts '1'
    option authoritative '1'
    option readethers '1'
    option leasefile '/tmp/dhcp.leases'
    option resolvfile '/etc/resolv-gpd.conf'
    option nohosts '1'
    option nonegcache '1'
    option strictorder '1'

config dhcp 'wifi'
    option interface 'wifi'
    option start '100'
    option limit '150'
    option leasetime '12h'
</code></pre>

<h2>防火墙配置(iptables)</h2>

<p>修改<code>/etc/firewall.user</code>文件，配置如下：</p>

<pre><code>iptables -I FORWARD -o tun0 -j ACCEPT
iptables -t nat -A POSTROUTING -s 192.168.2.0/24 -j MASQUERADE
</code></pre>

<h2>防火墙配置(<code>/etc/config/firewall</code>)</h2>

<p>把该文件中的<code>lan</code>都改为<code>wifi</code>即可。</p>

<h2>USB配置</h2>

<p>wr703n只有4MB的闪存，装完OpenWrt以后，只剩--1.4Mb--的(现在rom自带了luci，所以刷好后的可用空间只有900多Kb了)可用空间了，这些空间只够装一些必备的工具，OpenVPN等一些软件就需要装载外挂的USB设备中了</p>

<h3>安装必备软件</h3>

<ol>
<li><code>kmod-usb-storage</code>, <code>block-mount</code>  用来挂载usb设备</li>
<li><code>kmod-fs-ext4</code>  用来启用对文件系统的支持</li>
<li><strong><code>kmod-tun</code></strong> 虽然会随<code>openvpn</code>一起自动安装，但是将kmod-tun自动装在usb中可能会导致启动openvpn的时候提示tun设备无法找到的错误，所以在这里也将它先装到闪存中</li>
<li><code>ldconfig</code>  使得安装在USB中的lib能被找到</li>
</ol>


<blockquote><p>  opkg update
  opkg install [package name]</p></blockquote>

<p>将<code>[package name]</code>替换为包名，可以连续键入多个包名，以空格隔开</p>

<h3>配置USB设备</h3>

<p>可以先找一台Ubuntu机器或者在Mac上先将U盘分区、格式化成FAT格式，但是在Mac中创建分区时最好创建成Windows格式的分区表，如果创建成GUID格式的话，可能会多处一个分区，导致U盘的可用空间分区名会变成<code>sda2</code></p>

<p>在Mac上分区格式化成功后，就可以将U盘接到路由器上，对其进行格式化，使其成为ext4格式</p>

<pre><code>mkfs.ext4 -j /dev/sda1
</code></pre>

<p>等待结束后，就可以将U盘挂载到路由器上了</p>

<pre><code>mkdir /mnt/usb
mount /dev/sda1 /mnt/usb
</code></pre>

<p>这时候就可以查看到已有设备中已经挂载了<code>/dev/sda1</code></p>

<pre><code>df -h
</code></pre>

<p>成功mount后，可以修改<code>/etc/config/fstab</code>，让USB设备在路由器启动时自动挂载</p>

<pre><code>config mount
    option uuid 033ab6ac-22ef-40c1-8a31-2dd61de49302
    option target /mnt/usb
    option device /dev/sda1
    option fstype ext4
    option options  rw,sync
    option enabled  1
    option enabled_fsck 0
</code></pre>

<p>其中的<code>uuid</code>可以由<code>blkid</code>命令查到，最后要启动fatab服务</p>

<pre><code>/etc/init.d/fstab enable
/etc/init.d/fstab start
</code></pre>

<p>这样就完成了USB设备的配置</p>

<h2>安装OpenVPN</h2>

<p>要在usb设备中安装软件需要在<code>/etc/opkg.conf</code>中添加<code>dest usb /mnt/usb</code>，之后执行一下命令</p>

<pre><code>opkg -dest usb install openvpn
</code></pre>

<p>安装安成后，可以在<code>/etc/profile</code>系统路径中加入openvpn的路径</p>

<p>接下来要配置ldconfig，比较简单，创建文件<code>/etc/ld.so.conf</code>，在其中写入需要载入的lib文件路径即可，然后键入命令，启用配置</p>

<pre><code>ldconfig
</code></pre>

<p>最后，上传OpenVPN配置文件，启动OpenVPN，就可以实现在路由器上自由爬墙了～</p>

<h2>后记</h2>

<ul>
<li>可以配合使用chnroute，减少openvpn的流量消耗</li>
<li>本文大部分内容都是源于这两个博客，感谢这两个博主的文章：<a href="http://blog.proadm.net/blog/2011/10/25/Building-a-GFWless-AP-on-WR703n/">Lei Yang's Geek Life</a> 和 <a href="http://www.ratazzi.org/2012/02/09/install-openvpn-and-openwrt-on-wr703n/">Ratazzis's Blog</a></li>
</ul>


<h2>PS:</h2>

<p>首先将openvpn的默认配置文件复制到<code>/etc/config</code>中</p>

<pre><code>cp /mnt/usb/etc/config/openvpn /etc/config/
</code></pre>

<p>修改默认配置文件中的第一个配置</p>

<pre><code>config openvpn custom_config

    # Set to 1 to enable this instance:
    option enabled 1

    # Include OpenVPN configuration
    option config /mnt/usb/vpn/config.ovpn
</code></pre>

<p>主要将<code>enable</code>设置为<code>1</code>，配置文件指向自己的ovpn文件。</p>

<p>然后将启动脚本复制到<code>/etc/init.d/</code>中</p>

<pre><code>cp /mnt/usb/etc/init.d/openvpn /etc/init.d/
</code></pre>

<p>修改启动脚本中的openvpn二进制文件位置，改成/mnt/usb/开头的位置。</p>

<p>最后：</p>

<pre><code>/etc/init.d/openvpn enable
</code></pre>

<p>这样就配置好了openvpn和自动启动</p>

<h2>PPS:</h2>

<p>OpenVPN配置文件</p>

<p>首先，使用<a href="http://code.google.com/p/chnroutes/wiki/Usage">chnroute</a>配置openvpn，让访问国内网络不走vpn的链路。</p>

<p>使用chnroute的android配置文件即可</p>

<pre><code>python chnroute.py -p android
</code></pre>

<p>这样得到了<code>vpnup.sh</code>和<code>vpndown.sh</code>文件，并且把下载下来的文件中前面的<code>alias</code>内容注释掉，因为在openwrt中不需要这些配置，会导致openvpn启动错误。</p>

<p>将这两个文件上传到路由器的目录中，并将文件增加执行权限</p>

<pre><code>chmod a+x vpnup.sh &amp;&amp; chmod a+x vpndown.sh
</code></pre>

<p>接下来是openvpn的config文件，大致配置如下：</p>

<pre><code>remote yourhost port
client
dev tun
proto tcp
daemon
resolv-retry infinite
nobind
persist-key
persist-tun
ca ca文件绝对路径
cert crt文件绝对路径
key key文件绝对路径
ns-cert-type server
comp-lzo
route-delay 2
route-method exe
verb 3
script-security 2
up vpnup.sh文件绝对路径
down vpndown.sh文件绝对路径
log /tmp/openvpn.log
</code></pre>

<p>这样，重启后就搞定了。</p>
]]></content>
  </entry>
  
</feed>
